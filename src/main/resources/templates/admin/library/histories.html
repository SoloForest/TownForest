<html layout:decorate="~{home/layout.html}">
<head>
    <title>독서실 이용 현황</title>
    <script src="/js/dateUtil.js"></script>
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
    <meta name="_csrf" th:content="${_csrf.token}">
</head>
<body>
<!-- main -->
<main layout:fragment="main" class="flex flex-col">
    <!-- 자리 배치 표 -->
    <img src="/librarySeat.png" alt="자리 배치 표" class="mx-[5%]">
    <!-- card ui, 모든 독서실 히스토리 출력 -->
    <div class="card bg-base-900 shadow-xl m-[5%] rounded-xl">
        <div class="card-body p-3">
            <h2 class="card-title">이용 현황</h2>

            <P th:if="${histories.numberOfElements} == 0" class="text-center my-5">
                독서실 이용 히스토리가 없습니다.
            </P>
            <div th:if="${histories.numberOfElements} != 0">
                <div class="overflow-x-auto">
                    <table class="table text-center">
                        <!-- head -->
                        <thead>
                        <tr>
                            <th>Date.</th>
                            <th>User.</th>
                            <th>Address.</th>
                            <th>Seat No.</th>
                            <th>Status.</th>
                            <th></th>
                        </tr>
                        </thead>

                        <!-- 페이지 변수를 받아서 thymeleaf로 작성하기 -->
                        <tbody id="contentList">
                        <!-- row 1 -->
                        <tr th:each="history : ${histories}">
                            <td th:text="${#temporals.format(history.date, 'yyyy.MM.dd HH:mm:ss')}"></td>
                            <td th:text="${history.user.account.fullName}" style="min-width: 86px;"></td>
                            <td th:text="${history.addressToString}"></td>
                            <td th:text="${history.seat.seatNumber}"></td>
                            <td th:text="${history.statusTypeToString}" style="min-width:80px; padding: 12px 0;"></td>
                            <td th:if="${history.statusType} == 0" style="min-width:100px; padding: 12px 0;">
                                <button th:onclick="submitAdminCancel([[${history.id}]])"
                                        class="btn btn-info btn-sm text-white cancel-button">
                                    취소하기
                                </button>
                            </td>
                        </tr>
                        </tbody>

                    </table>
                </div>

                <!-- 넘버링 페이지 -->
                <div class="btn-group flex justify-center mt-7" th:if="${!histories.isEmpty()}">
                    <div class="btn" th:classappend="${histories.number == 0} ? 'btn-disabled' : ''"
                         th:attr="onclick='window.location.href=\'?page=0&size=25\''">
                        &laquo;
                    </div>
                    <div th:attr="onclick='window.location.href=\'?page=' + (${histories.number - 1}) + '&size=25\''"
                         class="btn" th:classappend="${!histories.hasPrevious} ? 'btn-disabled' : ''">
                        이전
                    </div>
                    <div class="btn" th:each="page: ${#numbers.sequence(0, histories.totalPages - 1)}"
                         th:classappend="${histories.number == page} ? 'btn-active' : ''"
                         th:if="${page >= histories.number - 1 and page <= histories.number + 2}"
                         th:attr="onclick='window.location.href=\'?page=' + (${page}) + '&size=25\''"
                         th:text="${page+1}">
                    </div>
                    <div class="btn" th:classappend="${!histories.hasNext} ? 'btn-disabled' :''"
                         th:attr="onclick='window.location.href=\'?page=' + (${histories.number + 1}) + '&size=25\''">
                        다음
                    </div>
                    <div th:attr="onclick='window.location.href=\'?page=' + (${histories.totalPages - 1}) + '&size=25\''"
                         class="btn"
                         th:classappend="${histories.number == histories.totalPages - 1} ? 'btn-disabled' : ''">
                        &raquo;
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        function submitAdminCancel(historyId) {
            let header = $("meta[name='_csrf_header']").attr('content');
            let token = $("meta[name='_csrf']").attr('content');

            $.ajax({
                url: '/admin/library/cancel',
                type: 'POST',
                data: {
                    libraryHistoryId: historyId * 1
                },
                beforeSend: function (xhr) {
                    xhr.setRequestHeader(header, token);
                },
                success: function (result) {
                    alert(result);
                    window.location.reload();
                },
                error: function (err) {
                    console.log("Error fetching data:", err);
                }
            });
        }
    </script>
</main>
</body>
</html>
